#!/usr/bin/env perl

#
# Installation requirements
#   perl-Redis
#   perl-Time-HiRes
#   perl-Data-Faker
#

use strict;
use warnings;
use Redis;
use Getopt::Long;
use Data::Faker;

my $size = 1000;
my $tag = '';
my $type = '';
my $batch = 50;
my $starttime;
my $endtime;

GetOptions (
  'size=i' => \my $my_size,
  'tag=s' => \my $my_tag,
  'type=s' => \my $my_type,
  'batch=i' => \my $my_batch,
) or die "Invalid options passed to $0\n";

sub getstarttime {
  $starttime = Time::HiRes::gettimeofday();
}

sub getendtime {
  $endtime = Time::HiRes::gettimeofday();
}

sub getelapsedtime {
  printf("Elapsed time: %.2f\n", $endtime - $starttime);
}

my $redis = Redis->new;

$redis->ping || die "no server?";

print "Inserting $my_size records\n";

my $count = 1;

if ( $my_type eq 'HSET' or $my_type eq 'hset' )
{
  getstarttime();
  while ($count <= $my_size)
  {
    my $faker = Data::Faker->new();
    my @responses;
    if ( $my_tag ne '')
    {
      $redis->hmset("emp:{$my_tag}:$count", "name", $faker->name, "address", $faker->street_address, "city", $faker->city, sub {});
    }else{
      $redis->hmset("emp:$count", "name", $faker->name, "address", $faker->street_address, "city", $faker->city, sub {});
    }

    my $res = $count % $my_batch;

    if ( $res eq 0 )
    {
      $redis->wait_one_response;
    }

    $count += 1;
  }
  $redis->wait_one_response;
  getendtime();
  getelapsedtime();
}

__END__

=head1 NAME

redis-data-generator - A simple Redis/Valkey data generator

=head1 SYNOPSYS

redis-data-generator [options]

  Options:
    -help          Display the help message
    -size          Number of records to generate
    -tag           The hash tag [eg key:{tag}:value]
    -type          Data type to generate [eg. HASH, STRING, etc]
    -batch         Size of records in pipeline

=head1 OPTIONS

=over 8

=item B<-help>

Display the help message and exit.

=item B<-size>

Number of records to generate.

=item B<-tag>

The hash tag to use (optional)

=item B<-type>

The data type to generate. Case-insensitive and only support HASH or hash for now.

=item B<-batch>

The nunber of records in the pipeline 

=back

=head1 DESCRIPTION

This program is a simple data generator for Redis/Valkey.

=cut